generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql" // Change to mysql/sqlite if needed
  url      = env("DATABASE_URL")
}

enum UserStatus {
  active
  inactive
  disabled
}

enum UserRole {
  SUPER_ADMIN
  CLIENT
  END_USER
}

enum ClientStatus {
  active
  inactive
  suspended
}

enum NotificationMethod {
  WHATSAPP
  EMAIL
  BOTH
}

enum PaymentMethod {
  RAZORPAY
  STRIPE
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  OVERDUE
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum DurationUnit {
  MINUTES
  HOURS
  DAYS
  WEEKS
  MONTHS
}

// Super Admin and Client users (platform users)
model User {
  id             String     @id @default(uuid()) @map("id")
  name           String     @map("name")
  email          String     @unique @map("email")
  phone          String?    @map("phone")
  password       String     @map("password")
  role           UserRole   @default(CLIENT) @map("role")
  status         UserStatus @default(active) @map("status")
  profilePicture String?    @map("profile_picture")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  // If user is a client, they have a client profile
  client   Client?   @relation("ClientUser")
  UserOtp  UserOtp[]

  @@map("users")
}

// Client (Business Owner) - has their own users and manages subscriptions
model Client {
  id          String       @id @default(uuid()) @map("id")
  userId      String       @unique @map("user_id")
  businessName String      @map("business_name")
  description String?      @map("description")
  status      ClientStatus @default(active) @map("status")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  user          User           @relation("ClientUser", fields: [userId], references: [id], onDelete: Cascade)
  endUsers      EndUser[]
  templates     Template[]
  subscriptions Subscription[]
  payments      Payment[]
  settings      ClientSettings?

  @@map("clients")
}

// End Users - customers of the clients who receive payment reminders
model EndUser {
  id        String     @id @default(uuid()) @map("id")
  clientId  String     @map("client_id")
  name      String     @map("name")
  email     String?    @map("email")
  phone     String?    @map("phone")
  status    UserStatus @default(active) @map("status")
  metadata  Json?      @map("metadata") // For storing custom fields
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  // Relations
  client        Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  payments      Payment[]

  @@unique([clientId, email])
  @@unique([clientId, phone])
  @@map("end_users")
}

// Message templates for payment reminders
model Template {
  id                 String             @id @default(uuid()) @map("id")
  clientId           String             @map("client_id")
  name               String             @map("name")
  title              String             @map("title")
  body               String             @map("body") @db.Text
  recurringDuration  Int                @map("recurring_duration")
  durationUnit       DurationUnit       @map("duration_unit")
  notificationMethod NotificationMethod @map("notification_method")
  paymentMethod      PaymentMethod      @map("payment_method")
  defaultAmount      Decimal?           @map("default_amount") @db.Decimal(10, 2)
  isActive           Boolean            @default(true) @map("is_active")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  client        Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  @@map("templates")
}

// Recurring payment subscriptions
model Subscription {
  id             String             @id @default(uuid()) @map("id")
  clientId       String             @map("client_id")
  endUserId      String             @map("end_user_id")
  templateId     String             @map("template_id")
  amount         Decimal            @map("amount") @db.Decimal(10, 2)
  status         SubscriptionStatus @default(ACTIVE) @map("status")
  nextDueDate    DateTime           @map("next_due_date")
  lastPaidDate   DateTime?          @map("last_paid_date")
  startDate      DateTime           @default(now()) @map("start_date")
  endDate        DateTime?          @map("end_date")
  customOverrides Json?             @map("custom_overrides") // For custom amount, duration overrides
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  // Relations
  client   Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  endUser  EndUser   @relation(fields: [endUserId], references: [id], onDelete: Cascade)
  template Template  @relation(fields: [templateId], references: [id])
  payments Payment[]

  @@map("subscriptions")
}

// Individual payment records
model Payment {
  id             String        @id @default(uuid()) @map("id")
  clientId       String        @map("client_id")
  endUserId      String        @map("end_user_id")
  subscriptionId String        @map("subscription_id")
  amount         Decimal       @map("amount") @db.Decimal(10, 2)
  status         PaymentStatus @default(PENDING) @map("status")
  dueDate        DateTime      @map("due_date")
  paidDate       DateTime?     @map("paid_date")
  paymentMethod  PaymentMethod @map("payment_method")
  gatewayPaymentId String?     @map("gateway_payment_id") // Razorpay/Stripe payment ID
  gatewayResponse Json?        @map("gateway_response")
  notificationsSent Int        @default(0) @map("notifications_sent")
  lastNotificationSent DateTime? @map("last_notification_sent")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  endUser      EndUser      @relation(fields: [endUserId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// Client settings for API keys and configurations
model ClientSettings {
  id                    String  @id @default(uuid()) @map("id")
  clientId              String  @unique @map("client_id")
  whatsappApiKey        String? @map("whatsapp_api_key") // Encrypted
  whatsappBusinessPhone String? @map("whatsapp_business_phone")
  emailSmtpHost         String? @map("email_smtp_host")
  emailSmtpPort         Int?    @map("email_smtp_port")
  emailSmtpUser         String? @map("email_smtp_user")
  emailSmtpPassword     String? @map("email_smtp_password") // Encrypted
  emailFromAddress      String? @map("email_from_address")
  razorpayKeyId         String? @map("razorpay_key_id")
  razorpayKeySecret     String? @map("razorpay_key_secret") // Encrypted
  stripePublishableKey  String? @map("stripe_publishable_key")
  stripeSecretKey       String? @map("stripe_secret_key") // Encrypted
  webhookSecret         String? @map("webhook_secret") // Encrypted
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_settings")
}

// Notification logs
model NotificationLog {
  id            String             @id @default(uuid()) @map("id")
  clientId      String             @map("client_id")
  endUserId     String             @map("end_user_id")
  paymentId     String?            @map("payment_id")
  method        NotificationMethod @map("method")
  recipient     String             @map("recipient") // Email or phone number
  subject       String?            @map("subject")
  content       String             @map("content") @db.Text
  status        String             @map("status") // sent, failed, delivered
  errorMessage  String?            @map("error_message")
  sentAt        DateTime           @default(now()) @map("sent_at")

  @@map("notification_logs")
}

model UserOtp {
  id        String   @id @default(uuid())
  userId    String   @unique
  otp       String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}
